var fs = require('fs');
var path = require('path');
var crypto = require('crypto');
var ms = require('memspace');

module.exports = user;

user.path = null;

user.initPath = function() {
    var _path = path.join(ms.memspace.getPathName(), 'users');
    if (fs.existsSync(_path)) {
        this.path = _path;
    }
    else {
        throw 'Path to user folder does not exist: ' + _path;
    }
    return this;
};

user.getPath = function() {
    if (this.path === null) {
        throw 'Path to user folder not set.';
    }
    return this.path;
};

user.loadByUsername = function(username) {
    var _path = path.join(this.getPath(), username+'.json');
    var user = null;
    if (fs.existsSync(_path)) {
        this.path = _path;
        user = JSON.parse(fs.readFileSync(_path, 'utf8'));    
    }
    else {
        throw 'Username does not exist: ' + username;
    }
    return user;
}

user.loadBySession = function(sessionId) {
    var user = null;
    if (typeof(sessionId) === 'undefined' || !sessionId.length) {
        throw 'sessionId cannot be empty.';
    }
    else {
        var session = ms.session.load(sessionId);
        user = this.loadByUsername(session.username);
        if (typeof(user) !== 'undefined') {
            delete user.auth;
        }
        else{
            throw 'SessionId invalid.';
        }
    }
    return user;
}

user.auth = function(username, password, duration) {
    var auth = null;
    if (typeof(username) === 'undefined' || !username.length
     || typeof(password) === 'undefined' || !password.length) {
        throw 'Username and password cannot be empty.';
    }
    else {
        var user = this.loadByUsername(username);
        if (typeof(user) !== 'undefined' 
         && typeof(user.auth.password) !== 'undefined'
         && typeof(user.auth.salt) !== 'undefined' 
         && hash(password, user.auth.salt) === user.auth.password) {
            delete user.auth;
            auth = {
                'sessionId': ms.session.generateId(),
                'user' : user
            };
            ms.session.save(auth.sessionId, {
                'memspace': ms.memspace.getPathName(), //maybe we shhould get the name..
                'username': username
            }, duration);
        }
        else{
            throw 'Password invalid.';
        }
    }
    return auth;
}

var hash = function(password, salt) {
    return crypto.createHmac('sha256', salt).update(password).digest('hex');
};

function user() {
    
}